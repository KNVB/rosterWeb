class RosterTable
{
	constructor()
	{
		this.month=0;		
		this.year=1970;
		this.itoList=null;
		this.rosterList=null;
		this.calendarList=null;		
		this.workingDayCount=0;
		this.totalHourCellIndex=34;
		this.shiftStartCellIndex=3;
		this.shiftRule=new ShiftRule();
		this.utility=new Utility();
		this.table=document.getElementById("rosterTable");
		this.rosterFooter=document.getElementById("footer");
		this.rosterBody=document.getElementById("rosterBody");
		this.rosterHeader=document.getElementById("rosterHeader");
		this.englishMonthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];
	}
	init(year,month)
	{
		var temp;
		var self=this;
		this.year=year;
		this.month=month;
		this.itoList=[];
		this.rosterList=[];
		$(this.rosterFooter).hide();
		var ito;
		var requestParameters={"year":year,"month":month}; 
		//console.log(requestParameters);
		var utility=new Utility()
		return	jQuery.ajax({"url": "getRoster.jsp",
			 			dataType: 'json',
			 			data:requestParameters,
			 			success:function (requestResult)
								{
			 						self.calendarList=requestResult.calendarList;
			 						for (var itoId in requestResult.itoList)
			 						{
			 							temp=(requestResult.itoList[itoId]);
			 							ito=new ITO();
			 							ito.name=temp.name;
			 							ito.itoId=temp.itoId;
			 							ito.postName=temp.postName;
			 							ito.availableShift=temp.availableShift;
			 							ito.workingHourPerDay=temp.workingHourPerDay;
			 							ito.blackListShiftPatternList=temp.blackListShiftPatternList;
			 							self.itoList[itoId]=ito;
			 						}
			 						self.rosterList=requestResult.rosterList;
			 						//$(self.table).empty();
				 						self.genRosterCaption();
				 						self.genRosterMonthRow();
				 						self.genEmptyRow();
				 						self.genRosterHeader();
				 						self.genRosterBody();
				 						self.loadRosterData();
				 						
				 						self.initAutoPlanDropDown();
				 						$(self.rosterFooter).show();
				 						
			 						},
			 			error:utility.showAjaxErrorMessage
					});
	}
	genRosterCaption()
	{
		var i,cell;
		//this.rosterHeader=this.table.createTHead();
		$(this.rosterHeader).empty();
		var captionRow=this.rosterHeader.insertRow(this.rosterHeader.rows.length);
		for (i=0;i<3;i++)
		{
			captionRow.insertCell(captionRow.cells.length);
		}
		cell=captionRow.insertCell(captionRow.cells.length);
		cell.textContent="EMSTF Resident Support & Computer Operation Support Services Team Roster";
		cell.className="underlineText alignCenter";
		cell.colSpan=31;
		for (i=0;i<10;i++)
		{
			captionRow.insertCell(captionRow.cells.length);
		}		
	}
	genRosterMonthRow()
	{
		var i,cell;
		var rosterMonthRow;
		var self=this;
		rosterMonthRow=this.rosterHeader.insertRow(this.rosterHeader.rows.length);
		rosterMonthRow.id="rosterMonthRow";
		for (i=0;i<3;i++)
		{
			rosterMonthRow.insertCell(rosterMonthRow.cells.length);
		}
		var monthSelect=document.createElement("select");
		cell=rosterMonthRow.insertCell(rosterMonthRow.cells.length);
		cell.append(monthSelect);
		
		for (i=0;i<this.englishMonthNames.length;i++)
		{
			var option=document.createElement("option");
			option.value=i;
			option.text=this.englishMonthNames[i];
			if (i==this.month)
				option.selected=true;
			monthSelect.append(option);
		}
		cell.colSpan=31;
		cell.className="underlineText alignCenter boldText";
		monthSelect.className="underlineText rosterMonthSelect";
		monthSelect.onchange=function(){
			self.refresh(self,this);
		};
		cell.append(document.createTextNode(this.year));
		for (i=0;i<10;i++)
		{
			rosterMonthRow.insertCell(rosterMonthRow.cells.length);
		}
	}
	genEmptyRow()
	{
		var i,cell;
		var rosterEmptyRow;
		rosterEmptyRow=this.rosterHeader.insertRow(this.rosterHeader.rows.length);
		
		cell=rosterEmptyRow.insertCell(rosterEmptyRow.cells.length);
		cell.colSpan=46;
				
	}
	genRosterHeader()
	{
		var i,cell,holidayCell,daysCell,datesCell;
		var holidayRow,daysRow,datesRow;

		holidayRow=this.rosterHeader.insertRow(this.rosterHeader.rows.length);
		daysRow=this.rosterHeader.insertRow(this.rosterHeader.rows.length);
		datesRow=this.rosterHeader.insertRow(this.rosterHeader.rows.length);
				
		cell=holidayRow.insertCell(holidayRow.cells.length);
		cell.className="borderCell alignLeft";
		cell.textContent="Holiday";
		
		cell=daysRow.insertCell(daysRow.cells.length);
		cell.className="borderCell alignLeft";
		cell.textContent="Days";
		
		cell=datesRow.insertCell(datesRow.cells.length);
		cell.className="borderCell alignLeft";
		cell.innerHTML="Resident Support<br>Team Members";
		
		for (i=0;i<2;i++)
		{
			cell=holidayRow.insertCell(holidayRow.cells.length);
			cell.className="dateCell borderCell";
			
			cell=daysRow.insertCell(daysRow.cells.length);
			cell.className="dateCell borderCell";
			
			cell=datesRow.insertCell(datesRow.cells.length);
			cell.className="dateCell borderCell";
		}
		//console.log(this.calendarList);
		this.workingDayCount=this.calendarList.length;
		for (i=0;i<31;i++)
		{
			holidayCell=holidayRow.insertCell(holidayRow.cells.length);
			holidayCell.className="borderCell boldText weekend";
			
			daysCell=daysRow.insertCell(daysRow.cells.length);
			daysCell.className="borderCell";
			
			datesCell=datesRow.insertCell(datesRow.cells.length);
			datesCell.className="borderCell";
			
			if (this.calendarList.length>i)
			{	
				datesCell.textContent=(i+1);
				daysCell.textContent=this.calendarList[i].weekday;
				switch (this.calendarList[i].weekday)
				{
					case "S":
					case "Su":
							daysCell.className+=" weekend";
							this.workingDayCount--;
							break;
					default:
							if (this.calendarList[i].isHoliday)
							{
								holidayCell.textContent="PH";
								daysCell.className+=" weekend";
								this.workingDayCount--;
							}
							break;
				}
			}
		}
		//console.log(this.workingDayCount);
		cell=holidayRow.insertCell(holidayRow.cells.length);
		cell.className="borderCell";
		cell.colSpan=10;
		
		cell=daysRow.insertCell(daysRow.cells.length);
		cell.className="borderCell theRestCell";
		cell.innerHTML="Total<br>Hour";
		cell.rowSpan=2;
		
		cell=daysRow.insertCell(daysRow.cells.length);
		cell.className="borderCell theRestCell";
		cell.innerHTML="Actual<br>Hour";
		cell.rowSpan=2;
		
		cell=daysRow.insertCell(daysRow.cells.length);
		cell.className="borderCell";
		cell.innerHTML="Hour Off Due";
		cell.colSpan=8;
		
		cell=datesRow.insertCell(datesRow.cells.length);
		cell.className="borderCell theRestCell";
		cell.innerHTML="Last<br>Month";
		
		cell=datesRow.insertCell(datesRow.cells.length);
		cell.className="borderCell theRestCell";
		cell.innerHTML="This<br>Month";

		cell=datesRow.insertCell(datesRow.cells.length);
		cell.className="borderCell theRestCell";
		cell.innerHTML="Total";
		
		cell=datesRow.insertCell(datesRow.cells.length);
		cell.className="borderCell theRestCell";
		cell.innerHTML="Total No. of<br>A shift";

		cell=datesRow.insertCell(datesRow.cells.length);
		cell.className="borderCell theRestCell";
		cell.innerHTML="Total No. of<br>Bx shift";
		
		cell=datesRow.insertCell(datesRow.cells.length);
		cell.className="borderCell theRestCell";
		cell.innerHTML="Total No. of<br>C shift";

		cell=datesRow.insertCell(datesRow.cells.length);
		cell.className="borderCell theRestCell";
		cell.innerHTML="Total No. of<br>Dx shift";

		cell=datesRow.insertCell(datesRow.cells.length);
		cell.className="borderCell theRestCell";
		cell.innerHTML="No. of<br>working<br>day";
		
	}
	genRosterBody()
	{
		var i,ito;
		var self=this;
		var shiftRow,requirementRow,vancantShiftRow,cell;
		var shiftList,itoRoster,columnCount;
		$(this.rosterBody).empty();
		for (var itoId in this.itoList)
		{
			ito=this.itoList[itoId];
			itoRoster=this.rosterList[itoId];
			shiftRow=this.rosterBody.insertRow(this.rosterBody.rows.length);
			requirementRow=this.rosterBody.insertRow(this.rosterBody.rows.length);
			
			shiftRow.id="shift_"+ito.itoId;
			requirementRow.id="requirement_"+ito.itoId;
			cell=shiftRow.insertCell(shiftRow.cells.length);
			cell.className="alignLeft borderCell";
			
			cell.innerHTML=ito.name+"<br>"+ito.postName+" Extn. 2458";
			
			cell=requirementRow.insertCell(requirementRow.cells.length);
			cell.className="alignLeft borderCell";
			cell.innerHTML="Requirement";
			
			for (i=0;i<2;i++)
			{
				cell=shiftRow.insertCell(shiftRow.cells.length);
				cell.className="borderCell";
				$(cell).on("blur",function()
						{
							self.updateValue(this);
						});
				cell=requirementRow.insertCell(requirementRow.cells.length);
				cell.className="borderCell";
			}
			for (i=0;i<31;i++)
			{
				cell=shiftRow.insertCell(shiftRow.cells.length);
				cell.className="borderCell shiftCell";
				cell.contentEditable="true";
				$(cell).on("blur",function()
						{
							self.updateValue(this);
						});
				$(cell).keydown(function(event)
								{
					 				switch(event.which)
					 				{
					 					case 13:event.preventDefault();
					 							this.blur();
					 							//console.log("I am here.");
					 							break;
					 				}
								});
				cell=requirementRow.insertCell(requirementRow.cells.length);
				cell.className="borderCell shiftCell";
				cell.contentEditable="true";
				$(cell).keydown(function(event)
						{
			 				switch(event.which)
			 				{
			 					case 13:event.preventDefault();
			 							this.blur();
			 							//console.log("I am here.");
			 							break;
			 				}
						});
				$(cell).on("blur",function(){
					this.className="borderCell shiftCell";
				});
			}
			cell=shiftRow.insertCell(shiftRow.cells.length);
			cell.className="borderCell";
			cell.textContent=Math.round(this.workingDayCount*ito.workingHourPerDay*100)/100;
			
			cell=requirementRow.insertCell(requirementRow.cells.length);
			cell.className="borderCell";

			cell=shiftRow.insertCell(shiftRow.cells.length);
			cell.className="borderCell";
			
			cell=requirementRow.insertCell(requirementRow.cells.length);
			cell.className="borderCell";

			cell=shiftRow.insertCell(shiftRow.cells.length);
			cell.className="borderCell";
			cell.textContent=itoRoster.lastMonthBalance;
			cell=requirementRow.insertCell(requirementRow.cells.length);
			cell.className="borderCell";
			
			for (i=0;i<7;i++)
			{
				cell=shiftRow.insertCell(shiftRow.cells.length);
				cell.className="borderCell";
			
				cell=requirementRow.insertCell(requirementRow.cells.length);
				cell.className="borderCell";
			}
		}	
		vancantShiftRow=this.rosterBody.insertRow(this.rosterBody.rows.length);
		vancantShiftRow.id="vancantShift";
		cell=vancantShiftRow.insertCell(vancantShiftRow.cells.length);
		cell.className="vancantShift borderCell";
		cell.textContent="Vancant Shifts";
		for (i=0;i<33;i++)
		{
			cell=vancantShiftRow.insertCell(vancantShiftRow.cells.length);
			cell.className="borderCell";
		}
		cell=vancantShiftRow.insertCell(vancantShiftRow.cells.length);
		cell.className="borderCell";
		cell.colSpan=5;

		cell=vancantShiftRow.insertCell(vancantShiftRow.cells.length);
		cell.className="borderCell";
		cell.id="shiftAStdDev";
		
		cell=vancantShiftRow.insertCell(vancantShiftRow.cells.length);
		cell.className="borderCell";
		cell.id="shiftBStdDev";
		
		cell=vancantShiftRow.insertCell(vancantShiftRow.cells.length);
		cell.className="borderCell";
		cell.id="shiftCStdDev";
		
		cell=vancantShiftRow.insertCell(vancantShiftRow.cells.length);
		cell.className="borderCell";
		cell.id="avgStdDev";
		
		cell=vancantShiftRow.insertCell(vancantShiftRow.cells.length);
		cell.className="borderCell";
	}
	refresh(self,select)
	{
		//console.log(self,select);
		var month=parseInt(select.options[select.selectedIndex].value);
		var year=parseInt(select.nextSibling.textContent);
		//console.log(year,month);
		self.init(year,month);
	}
	loadRosterData()
	{
		var i,cell,ito;
		var shiftList,itoId,shiftRow;
		for (var itoId in this.itoList)
		{
			ito=this.itoList[itoId];
			shiftList=this.rosterList[itoId].shiftList;
			
			shiftRow=document.getElementById("shift_"+ito.itoId);
			for (i=0;i<shiftList.length;i++)
			{
				cell=shiftRow.cells[i+1];
				$(cell).html(shiftList[i]).blur();
			}
		}
	}
	updateValue(theCell)
	{
		var shiftRow=theCell.parentElement;
		var itoId=shiftRow.id.replace("shift_","");
		var shift=theCell.textContent;
	//	console.log("|"+shift+"|");
		if (shift=="")
		{
			theCell.className="borderCell shiftCell";
			if (theCell.cellIndex>=this.shiftStartCellIndex)
				this._reCalculate(shiftRow);
		}
		else
		{
			var ito=this.itoList[itoId];
			if (ito.isValidShift(shift))
			{
				theCell.className="borderCell shiftCell";
				switch (shift)
				{
					case "a":
							theCell.className+=" aShiftColor";
							break;	
					case "b":
					case "b1":
							theCell.className+=" bShiftColor";
							break;
					case "c":
							theCell.className+=" cShiftColor";
							break;
					case "d":
					case "d1":
					case "d2":
					case "d3":
							theCell.className+=" dxShiftColor";
							break;
					case "O":
							theCell.className+=" oShiftColor";
							break;
				}
				if (theCell.cellIndex>=this.shiftStartCellIndex)
					this._reCalculate(shiftRow);
			}
		}
	}
	_reCalculate(shiftRow,shift)
	{
		var i,shift;
		var actualHour=0,shiftCount,myShiftRow;
		var aShiftCount=0,bShiftCount=0,cShiftCount=0,dShiftCount=0;
		var totalCell,actualCell,thisMonthCell,thisMonthBalanceCell,lastMonthCell;
		var aShiftCountCell,bShiftCountCell,cShiftCountCell,dShiftCountCell,noOfWorkingDayCell;
		actualCell=shiftRow.cells[this.totalHourCellIndex+1];
		totalCell=shiftRow.cells[this.totalHourCellIndex];
		lastMonthCell=shiftRow.cells[this.totalHourCellIndex+2];
		thisMonthCell=shiftRow.cells[this.totalHourCellIndex+3];
		thisMonthBalanceCell=shiftRow.cells[this.totalHourCellIndex+4];
		aShiftCountCell=shiftRow.cells[this.totalHourCellIndex+5];
		bShiftCountCell=shiftRow.cells[this.totalHourCellIndex+6];
		cShiftCountCell=shiftRow.cells[this.totalHourCellIndex+7];
		dShiftCountCell=shiftRow.cells[this.totalHourCellIndex+8];
		noOfWorkingDayCell=shiftRow.cells[this.totalHourCellIndex+9];
		for (i=this.shiftStartCellIndex;i<this.totalHourCellIndex;i++)
		{
			shift=shiftRow.cells[i].textContent;
			if (this.shiftRule.shiftHour[shift]!=null)
			{	
				actualHour+=this.shiftRule.shiftHour[shift];
				switch (shift)
				{
					case "a":
							aShiftCount++;
							break;	
					case "b":
					case "b1":
							bShiftCount++;
							break;
					case "c":
							cShiftCount++;
							break;
					case "d":
					case "d1":
					case "d2":
					case "d3":
							dShiftCount++;
							break;					
				}
			}
		}
		actualCell.textContent=Math.round(actualHour*100)/100;
		
		thisMonthCell.textContent=Math.round((actualHour-totalCell.textContent)*100)/100;
		thisMonthBalanceCell.textContent=Math.round((parseFloat(thisMonthCell.textContent)+parseFloat(lastMonthCell.textContent))*100)/100;
		
		//update total no. of varies shift value
		aShiftCountCell.textContent=aShiftCount;
		this._updateStandardDevValue("A",aShiftCountCell.cellIndex);
		
		bShiftCountCell.textContent=bShiftCount;
		this._updateStandardDevValue("B",bShiftCountCell.cellIndex);
		
		cShiftCountCell.textContent=cShiftCount;
		this._updateStandardDevValue("C",cShiftCountCell.cellIndex);
		
		dShiftCountCell.textContent=dShiftCount;
		
		noOfWorkingDayCell.textContent=Math.round((aShiftCount+bShiftCount+cShiftCount+dShiftCount)*100)/100;
		
	}
	initAutoPlanDropDown()
	{
		var i;
		var autoPlannStartDateSelectBox=document.getElementById("autoPlannStartDate");
		var autoPlanEndDateSelectBox=document.getElementById("autoPlanEndDate");
		
		$(autoPlannStartDateSelectBox).empty();
		$(autoPlanEndDateSelectBox).empty();
		for (i=1;i<=this.calendarList.length;i++)
		{
			$(autoPlannStartDateSelectBox).append("<option value="+i+">"+i+"</option>");
			$(autoPlanEndDateSelectBox).append("<option value="+i+">"+i+"</option>");
		}
		autoPlanEndDateSelectBox.options[i-2].selected=true;
	}
	_updateStandardDevValue(shiftName,cellIndex)
	{
		
		var shiftCount=[];
		var rows=this.getAllShiftRow(),row;

//		console.log("cellIndex="+cellIndex);
		for (var itoId in rows)
		{
			row=rows[itoId];
			
			if ((row.cells[cellIndex].textContent!="") &&(row.cells[cellIndex].textContent!="N.A."))
			{	
				shiftCount.push(parseInt(row.cells[cellIndex].textContent));
				//	console.log(itoId+","+row.cells[cellIndex].outerHTML);
				//shiftCount.push(parseInt(row.cells[cellIndex].textContent));
			}
		}
		//console.log("cellIndex="+cellIndex);
		if (shiftCount.length>0)
		{
			//console.log(shiftCount);
			//var vancantShiftRow=document.getElementById("vancantShift");
			var value=this.utility.getSD(shiftCount);
			console.log(shiftCount,value);
			document.getElementById("shift"+shiftName+"StdDev").textContent=value;
			//vancantShiftRow.cells[cellIndex-4].textContent=value;
		}
		shiftCount=[];
		shiftCount.push(parseFloat(document.getElementById("shiftAStdDev").textContent));
		shiftCount.push(parseFloat(document.getElementById("shiftBStdDev").textContent));
		shiftCount.push(parseFloat(document.getElementById("shiftCStdDev").textContent));
		document.getElementById("avgStdDev").textContent=this.utility.getMean(shiftCount);
		//console.log("++++++++++++++++++++++++++++++++");
	}
//----------------------------------------------------------------------------------------------------------------------------------	
	clearAllShift()
	{
		var itoId,shiftRow,shiftRows=this.getAllShiftRow();
		var vancantShiftRow=document.getElementById("vancantShift");
		for (var itoId in shiftRows)
		{
			shiftRow=shiftRows[itoId];
			for (var j=this.shiftStartCellIndex;j<this.totalHourCellIndex;j++)
			{
				$(shiftRow.cells[j]).html("").blur();
				$(vancantShiftRow.cells[j]).html("");
			}	
		}
		
		
	}
	getAllShiftRow()
	{
		var result=[];
		var shiftRow;
		for (var itoId in this.itoList)
		{
			shiftRow=document.getElementById("shift_"+itoId);
			result[itoId]=shiftRow;
		}
		return result;
	}
	getAllRequirementRow()
	{
		var result=[];
		var requirementRow;
		for (var itoId in this.itoList)
		{
			requirementRow=document.getElementById("requirement_"+itoId);
			result[itoId]=requirementRow;
		}
		return result;
	}
	
}